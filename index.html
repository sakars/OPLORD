<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="styles.css" rel="stylesheet">
<title>Transport</title>
</head>
<body id="body">
<div id = "imageContainer">
  <img src="Images/LV_stars.png" id = "LVstars">
</div>
<canvas id="bottomUpdate" width="4000"></canvas>
<canvas id="middle" width="4000"></canvas>
<canvas id="stopC" width="4000"></canvas>
<canvas id="topUpdate" width="4000"></canvas>
<div class="center" id="timeContainer">
  <div class="center" id="timeDisplay">00:00</div>
  <div class="center" id="dayDisplay"></div>
  <div class="center" id="podDisplay">POD: Night</div>
<input class="center" type="range" min="10" max="50" value="10" class="slider" id="timeSlider">
</div>
<video class="center" id = "loader" width="2200" height="3600" loop>
  <source src="Videos/Animation_load_1_1.mp4" type="video/mp4">
Your browser does not support video playback.
</video>
<div id="console2"></div>
<script src="recycler.js"></script>
<script src="drawer.js"></script>
<script src="bus.js"></script>
<script src="Stops.js"></script>
<script src="daycycle.js"></script>
<script>

  //getting background image
  var latv=new Image();
  latv.src="Images/LV_2_lv_st_19.png";

  //scale constants
  const width = 8.25;
  const height = 3.08;
  const left = 20.41;
  const ttop = 58.44;

  //declaring globbal variables
  var stops;
  var down=false;
  var mid=left+width/2;
  var acth;
  var actw;
  var busses=[];
  var zoom=100;
  var pr=0;
  var stackSize=0;
  var interval;
  var loaderTimeout = false;
  var lvfilter = "brightness(100%)";//filter for canvas - day/night
  var Console = new Console2();
  var mwdw;//middle.width/width
  var mhdh;//middle.height/height

  function Console2(){//Console - textbox on the right
    this.log = function(e){
      console2.innerHTML += "[ " + timeDisplay.innerHTML + " ] " + e + "<br>";
      console2.scrollTop = console2.scrollHeight;
    }
  }
  function EyeOpener(Ob, index){//shows all busstops
    var l=coorToCanvas(Ob.degE,Ob.degN);
    stops[index].x=l[0];
    stops[index].y=l[1];
    //ctx.fillRect(l[0]-2,l[1]-2,4,4);
  }
  function init(){//initializes canvas and busstops
    mtx=middle.getContext("2d");
    stx=stopC.getContext("2d");
    btx=bottomUpdate.getContext("2d");
    ttx=topUpdate.getContext("2d");
    middle.width=window.innerWidth-10;
    middle.height=window.innerHeight;
    if((window.innerWidth/window.innerHeight)<(latv.width/latv.height)){
      acth=latv.height*(middle.width/latv.width)*2;
      actw=middle.width*2;
    }else{
      acth=middle.height*2;
      actw=latv.width*(middle.height/latv.height)*2;
    }
    middle.height=acth;
    bottomUpdate.height=acth;
    topUpdate.height=acth;
    middle.width=actw;
    bottomUpdate.width=actw;
    topUpdate.width=actw;
    stopC.height=acth;
    stopC.width=actw;
    mwdw=middle.width/width;
    mhdh=middle.height/height;
/*
    mtx.translate((window.innerWidth-actw)/2,0);
    stx.translate((window.innerWidth-actw)/2,0);
    btx.translate((window.innerWidth-actw)/2,0);
    ttx.translate((window.innerWidth-actw)/2,0);
*/
    recycle();//@recycler.js  Gets all files needed and repurpouses them
    waiter();
  }
  function waiter(){//function that waits until the files are fetched
    if(done==false){//@recycler.js
      setTimeout(waiter,10);
      return;
    }
    stops=reA;//@recycler.js
    loader.style.opacity = "0";
    loaderTimeout = false;
    Console.log("Sveiki! Šeit redzēsiet visus izbraucošos autobusus!");
    body.style.transition = "background-color 5s ease";
    setTimeout(function(){//when lodaer stops fading out
      loader.parentNode.removeChild(loader);
      bottomUpdate.style.opacity = "1";
      imageContainer.style.opacity = "1";
      middle.style.opacity = "1";
      middle.style.transition = "filter 50s ease";
      topUpdate.style.opacity = "1";
      stopC.style.opacity = "1";
      timeContainer.style.opacity = "1";
      console2.style.opacity = "1";
      console2.style.width = (document.body.clientWidth - middle.width - 30) + "px";
      console2.style.height = (window.innerHeight*2 - 30) + "px";
    }, 800);
    setTimeout(function(){//sets body bg transition for normal cycle
      body.style.transition = "background-color 50s ease";
    }, 5000);
    mtx.drawImage(latv,0,0,middle.width,middle.height);

    stx.save();
    ttx.save();
    btx.save();
    mtx.save();

    stops.forEach(EyeOpener);
    stops.forEach(StopDraw);
    busses.forEach(coorInit);
    //busses
    /*
    for(var i=0;i<1500;i++){
      busses.push(new Bus([stops[random(0,8000)],stops[random(0,8000)],stops[random(0,8000)]]));
    }
    */
    updateTime();
    //event listeners
    topUpdate.addEventListener("mousewheel", resize, false);
    topUpdate.addEventListener("DOMMouseScroll", resize, false);
    topUpdate.addEventListener("mouseup", function(){down=false;}, false);
    topUpdate.addEventListener("mousedown", function(e){down=true;prX=e.clientX;prY=e.clientY;}, false);
    topUpdate.addEventListener("mousemove", move, false);

    //starts update with 60fps
    interval=setInterval(update,1000/60);
  }

  function random(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function update(){//main update
    stackSize++;
    if(stackSize>=4){return;}
    ttx.clearRect(0,0,actw,acth);
    ttx.fillStyle="red";
    busses.forEach(BusUpdate);//@bus.js
    stackSize--;
    //setTimeout(update,10);
  }

  function fadeIn(){//loader fade at the start
    loader.style.opacity = "1";
    tryLoaderPlay();
    setTimeout(init, 300);
  }

  function tryLoaderPlay(){//tries playing loader animation
    try{
      document.getElementById("loader").play();
    }
    catch(e){}
    if(loaderTimeout){
      setTimeout(tryLoaderPlay, 2000);
    }
  }

  window.addEventListener('load', fadeIn, false);
</script>
</body>
</html>
